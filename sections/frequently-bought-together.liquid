{% comment %}
  Frequently Bought Together
  This section allows customers to select multiple products to add to cart together
{% endcomment %}

{{ 'frequently-bought-together.css' | asset_url | stylesheet_tag }}

<div class="page-width">
  <div class="frequently-bought-together">
    <h2 class="frequently-bought-together__heading">{{ section.settings.heading }}</h2>
    
    <div class="frequently-bought-together__container">
      <div class="frequently-bought-together__products">
        {% if section.settings.main_product_show %}
          <div class="frequently-bought-together__product-item main-product">
            <div class="frequently-bought-together__checkbox-container">
              <input type="checkbox" id="main-product-checkbox" class="fbt-checkbox" checked data-product-id="{{ product.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}" data-price="{{ product.selected_or_first_available_variant.price | money_without_currency | replace: ',', '' }}">
            </div>
            <div class="frequently-bought-together__product-image">
              <img src="{{ product.featured_image | img_url: '300x300', crop: 'center' }}" alt="{{ product.title | escape }}">
             
            </div>
            <div class="frequently-bought-together__product-details">
              <h3 class="frequently-bought-together__product-title">{{ product.title }}</h3>
              <span class="frequently-bought-together__product-price">₹ {{ product.selected_or_first_available_variant.price | money_without_currency | remove: '.00' }}</span>
            </div>
          </div>
          
          {% assign has_related_products = false %}
          
          {% comment %} Check if this product has specific related products in metafields {% endcomment %}
          {% if product.metafields.custom.related_product_1 != blank or product.metafields.custom.related_product_2 != blank %}
            {% assign has_related_products = true %}
            
            {% if product.metafields.custom.related_product_1 != blank %}
              <div class="frequently-bought-together__plus">+</div>
              {% assign related_product = product.metafields.custom.related_product_1 %}
              {% assign first_variant = related_product.selected_or_first_available_variant %}
              
              <div class="frequently-bought-together__product-item">
                <div class="frequently-bought-together__checkbox-container">
                  <input type="checkbox" id="product-{{ related_product.id }}" class="fbt-checkbox" checked data-product-id="{{ related_product.id }}" data-variant-id="{{ first_variant.id }}" data-price="{{ first_variant.price | money_without_currency | replace: ',', '' }}">
                </div>
                <div class="frequently-bought-together__product-image">
                  <img src="{{ related_product.featured_image | img_url: '300x300', crop: 'center' }}" alt="{{ related_product.title | escape }}">
                </div>
                <div class="frequently-bought-together__product-details">
                  <h3 class="frequently-bought-together__product-title">{{ related_product.title }}</h3>
                  {% if related_product.has_only_default_variant %}
                    <span class="frequently-bought-together__product-price">₹ {{ first_variant.price | money_without_currency | remove: '.00' }}</span>
                  {% else %}
                    <div class="frequently-bought-together__variant-selector">
                      <select class="fbt-variant-selector" data-product-id="{{ related_product.id }}">
                        {% for variant in related_product.variants %}
                          <option value="{{ variant.id }}" data-price="{{ variant.price | money_without_currency | replace: ',', '' }}">
                            {{ variant.title }} - ₹ {{ variant.price | money_without_currency | remove: '.00' }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
            
            {% if product.metafields.custom.related_product_2 != blank %}
              <div class="frequently-bought-together__plus">+</div>
              {% assign related_product = product.metafields.custom.related_product_2 %}
              {% assign first_variant = related_product.selected_or_first_available_variant %}
              
              <div class="frequently-bought-together__product-item">
                <div class="frequently-bought-together__checkbox-container">
                  <input type="checkbox" id="product-{{ related_product.id }}" class="fbt-checkbox" checked data-product-id="{{ related_product.id }}" data-variant-id="{{ first_variant.id }}" data-price="{{ first_variant.price | money_without_currency | replace: ',', '' }}">
                </div>
                <div class="frequently-bought-together__product-image">
                  <img src="{{ related_product.featured_image | img_url: '300x300', crop: 'center' }}" alt="{{ related_product.title | escape }}">
                </div>
                <div class="frequently-bought-together__product-details">
                  <h3 class="frequently-bought-together__product-title">{{ related_product.title }}</h3>
                  {% if related_product.has_only_default_variant %}
                    <span class="frequently-bought-together__product-price">₹ {{ first_variant.price | money_without_currency | remove: '.00' }}</span>
                  {% else %}
                    <div class="frequently-bought-together__variant-selector">
                      <select class="fbt-variant-selector" data-product-id="{{ related_product.id }}">
                        {% for variant in related_product.variants %}
                          <option value="{{ variant.id }}" data-price="{{ variant.price | money_without_currency | replace: ',', '' }}">
                            {{ variant.title }} - ₹ {{ variant.price | money_without_currency | remove: '.00' }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endif %}
          
          {% comment %} If no metafields are set, fallback to the blocks {% endcomment %}
          {% if has_related_products == false and section.blocks.size > 0 %}
            {% assign product_count = 0 %}
            {% for block in section.blocks %}
              {% if block.type == 'product' and block.settings.product != blank %}
                {% assign related_product = block.settings.product %}
                {% assign first_variant = related_product.selected_or_first_available_variant %}
                {% assign product_count = product_count | plus: 1 %}
                
                {% if product_count <= 2 %}
                  <div class="frequently-bought-together__plus">+</div>
                  <div class="frequently-bought-together__product-item" {{ block.shopify_attributes }}>
                    <div class="frequently-bought-together__checkbox-container">
                      <input type="checkbox" id="product-{{ related_product.id }}" class="fbt-checkbox" checked data-product-id="{{ related_product.id }}" data-variant-id="{{ first_variant.id }}" data-price="{{ first_variant.price | money_without_currency | replace: ',', '' }}">
                    </div>
                    <div class="frequently-bought-together__product-image">
                      <img src="{{ related_product.featured_image | img_url: '300x300', crop: 'center' }}" alt="{{ related_product.title | escape }}">
                    </div>
                    <div class="frequently-bought-together__product-details">
                      <h3 class="frequently-bought-together__product-title">{{ related_product.title }}</h3>
                      {% if related_product.has_only_default_variant %}
                        <span class="frequently-bought-together__product-price">₹ {{ first_variant.price | money_without_currency | remove: '.00' }}</span>
                      {% else %}
                        <div class="frequently-bought-together__variant-selector">
                          <select class="fbt-variant-selector" data-product-id="{{ related_product.id }}">
                            {% for variant in related_product.variants %}
                              <option value="{{ variant.id }}" data-price="{{ variant.price | money_without_currency | replace: ',', '' }}">
                                {{ variant.title }} - ₹ {{ variant.price | money_without_currency | remove: '.00' }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>

      <div class="frequently-bought-together__summary">
        <div class="frequently-bought-together__total">
          <span class="frequently-bought-together__total-label">{{ section.settings.total_price_text }}</span>
          <span class="frequently-bought-together__total-price" id="fbt-total-price"></span>
        </div>
        
        <button type="button" class="frequently-bought-together__add-button" id="fbt-add-to-cart-button">
          {{ section.settings.add_to_cart_text }}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.fbt-checkbox');
    const variantSelectors = document.querySelectorAll('.fbt-variant-selector');
    const totalPriceElement = document.getElementById('fbt-total-price');
    const addToCartButton = document.getElementById('fbt-add-to-cart-button');
    
    function updateTotalPrice() {
      let totalPrice = 0;
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          totalPrice += parseFloat(checkbox.dataset.price);
        }
      });
      
      totalPriceElement.textContent = formatMoney(totalPrice);
    }
    
    function formatMoney(cents) {
      return '₹ ' + parseInt(cents).toString();
    }
    
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateTotalPrice);
    });
    
    variantSelectors.forEach(selector => {
      selector.addEventListener('change', function() {
        const productId = this.dataset.productId;
        const variantId = this.value;
        const price = this.options[this.selectedIndex].dataset.price;
        const checkbox = document.querySelector(`.fbt-checkbox[data-product-id="${productId}"]`);
        
        checkbox.dataset.variantId = variantId;
        checkbox.dataset.price = price;
        
        updateTotalPrice();
      });
    });
    
    addToCartButton.addEventListener('click', function() {
      const items = [];
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          items.push({
            id: checkbox.dataset.variantId,
            quantity: 1
          });
        }
      });
      
      if (items.length > 0) {
        addToCartButton.classList.add('loading');
        addToCartButton.disabled = true;
        
        // Simple approach: Add items to cart and then refresh with cart drawer parameter
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ items: items })
        })
        .then(response => response.json())
        .then(data => {
          // Redirect to current page with cart drawer parameter
          window.location.href = window.location.pathname + '?drawer=cart';
        })
        .catch(error => {
          console.error('Error:', error);
          addToCartButton.classList.remove('loading');
          addToCartButton.disabled = false;
        });
      }
    });
    
    updateTotalPrice();
  });
</script>

{% schema %}
{
  "name": "Bought Together",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Frequently Bought Together"
    },
    {
      "type": "checkbox",
      "id": "main_product_show",
      "label": "Show main product",
      "default": true
    },
    {
      "type": "text",
      "id": "total_price_text",
      "label": "Total price text",
      "default": "Total price"
    },
    {
      "type": "text",
      "id": "savings_text",
      "label": "Bundle savings text",
      "default": "Bundle Savings"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to cart button text",
      "default": "ADD SELECTED TO CART"
    },
    {
      "type": "paragraph",
      "content": "For product-specific recommendations, add metafields to each product: custom.related_product_1 and custom.related_product_2 (reference type)"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Fallback Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product (fallback if no metafields)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Frequently Bought Together",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}
